<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>오늘의 카드사 혜택 모음</title>
  <style>
    :root{
      --bg:#F5F8FC; --card:#fff; --text:#0F172A; --muted:#64748B; --line:#E2E8F0;
      --blue:#2563EB; --blue2:#1D4ED8; --chip:#EEF2FF; --shadow:0 10px 30px rgba(15,23,42,.08);
      --radius:16px; --focus:0 0 0 4px rgba(37,99,235,.18);
      --ok:#16A34A; --warn:#F59E0B; --danger:#DC2626;
      --max:1100px;

      /* Dark mode variables */
      --dark-bg: #1A202C;
      --dark-card: #2D3748;
      --dark-text: #E2E8F0;
      --dark-muted: #A0AEC0;
      --dark-line: #4A5568;
      --dark-chip: #2C5282;
      --dark-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
      --dark-header-bg: rgba(26, 32, 44, 0.78);
      --dark-card-hover-bg: #4A5568;
      --dark-input-bg: rgba(45, 55, 72, 0.86);
      --dark-modal-bg: #2D3748;
      --dark-modal-header-bg: linear-gradient(180deg, rgba(37,99,235,.16), rgba(45,55,72,1));
      --dark-modal-footer-bg: rgba(45, 55, 72, 0.75);
      --dark-panel-bg: rgba(45, 55, 72, 0.70);
      --dark-table-bg: #2D3748;
      --dark-table-th-bg: rgba(37,99,235,.15);
      --dark-pill-bg: rgba(226, 232, 240, 0.08);
    }
    
    html[data-theme='dark'] {
      --bg: var(--dark-bg);
      --card: var(--dark-card);
      --text: var(--dark-text);
      --muted: var(--dark-muted);
      --line: var(--dark-line);
      --chip: var(--dark-chip);
      --shadow: var(--dark-shadow);
    }
    html[data-theme='dark'] .header {
      background: var(--dark-header-bg);
      border-bottom-color: var(--dark-line);
    }
    html[data-theme='dark'] .searchbox input {
      background: var(--dark-input-bg);
      border-color: var(--dark-line);
      color: var(--dark-text);
    }
    html[data-theme='dark'] .searchbox input:focus {
      background: var(--dark-card);
    }
    html[data-theme='dark'] .btn {
      background: var(--dark-card);
      border-color: var(--dark-line);
      color: var(--dark-text);
    }
    html[data-theme='dark'] .btn:hover {
      background: var(--dark-card-hover-bg);
      border-color: rgba(37,99,235,.55);
    }
    html[data-theme='dark'] .btn.secondary {
      color: var(--dark-muted);
    }
    html[data-theme='dark'] .btn.primary {
      background: rgba(37,99,235,.2);
      border-color: rgba(37,99,235,.5);
      color: var(--blue);
    }
    html[data-theme='dark'] .chip {
      background: var(--dark-card);
      border-color: var(--dark-line);
      color: var(--dark-text);
    }
    html[data-theme='dark'] .chip:hover {
      background: var(--dark-card-hover-bg);
      border-color: rgba(37,99,235,.55);
    }
    html[data-theme='dark'] .chip[aria-pressed="true"] {
      background: var(--dark-chip);
      border-color: rgba(37,99,235,.75);
      color: var(--dark-text);
    }
    html[data-theme='dark'] .card {
      background: var(--dark-card);
      border-color: var(--dark-line);
    }
    html[data-theme='dark'] .card:hover {
      background: var(--dark-card-hover-bg);
      border-color: rgba(37,99,235,.55);
    }
    html[data-theme='dark'] .logo {
      background: var(--dark-card-hover-bg);
      border-color: var(--dark-line);
    }
    html[data-theme='dark'] .logo-fallback {
      background: linear-gradient(135deg, #A0AEC0, #CBD5E0);
      border-color: var(--dark-line);
    }
    html[data-theme='dark'] .pill {
      background: var(--dark-pill-bg);
      border-color: var(--dark-line);
      color: var(--dark-text);
    }
    html[data-theme='dark'] .badge-cat {
      border-color: var(--dark-line);
    }
    html[data-theme='dark'] .card-actions {
      border-top-color: var(--dark-line);
      background: linear-gradient(180deg, rgba(26, 32, 44, 0.0), rgba(26, 32, 44, 0.7));
    }
    html[data-theme='dark'] .btn-sq {
      background: rgba(37,99,235,.2);
      border-color: rgba(37,99,235,.5);
      color: var(--blue);
    }
    html[data-theme='dark'] .btn-sq:hover {
      background: rgba(37,99,235,.3);
      border-color: rgba(37,99,235,.7);
    }
    html[data-theme='dark'] .btn-sq.ghost {
      border-color: var(--dark-line);
      background: var(--dark-card);
      color: var(--dark-text);
    }
    html[data-theme='dark'] .btn-sq.ghost:hover {
      border-color: rgba(37,99,235,.55);
    }
    html[data-theme='dark'] .empty {
      background: var(--dark-card);
      border-color: var(--dark-line);
    }
    html[data-theme='dark'] .backdrop {
      background: rgba(0, 0, 0, 0.75);
    }
    html[data-theme='dark'] .modal {
      background: var(--dark-modal-bg);
      border-color: var(--dark-line);
    }
    html[data-theme='dark'] .modal-header {
      border-bottom-color: var(--dark-line);
      background: var(--dark-modal-header-bg);
    }
    html[data-theme='dark'] .close {
      background: var(--dark-card);
      border-color: var(--dark-line);
      color: var(--dark-text);
    }
    html[data-theme='dark'] .modal-body p {
      color: var(--dark-text);
    }
    html[data-theme='dark'] .modal-body ul {
      color: var(--dark-text);
    }
    html[data-theme='dark'] .modal-footer {
      border-top-color: var(--dark-line);
      background: var(--dark-modal-footer-bg);
    }
    html[data-theme='dark'] .panel {
      border-color: var(--dark-line);
      background: var(--dark-panel-bg);
    }
    html[data-theme='dark'] .table {
      border-color: var(--dark-line);
      background: var(--dark-table-bg);
    }
    html[data-theme='dark'] .table th, html[data-theme='dark'] .table td {
      border-bottom-color: var(--dark-line);
      color: var(--dark-text);
    }
    html[data-theme='dark'] .table th {
      background: var(--dark-table-th-bg);
      color: var(--dark-text);
    }
    html[data-theme='dark'] .field label {
      color: var(--dark-text);
    }
    html[data-theme='dark'] .field input, html[data-theme='dark'] .field select, html[data-theme='dark'] .field textarea {
      border-color: var(--dark-line);
      background: var(--dark-card);
      color: var(--dark-text);
    }
    html[data-theme='dark'] .mini {
      border-color: var(--dark-line);
      background: var(--dark-card);
      color: var(--dark-text);
    }
    html[data-theme='dark'] .mini:hover {
      border-color: rgba(37,99,235,.55);
    }
    html[data-theme='dark'] .mini.danger {
      border-color: rgba(220,38,38,.55);
      color: #F87171;
      background: rgba(220,38,38,.1);
    }
    html[data-theme='dark'] .mini.danger:hover {
      border-color: rgba(220,38,38,.75);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple SD Gothic Neo","Noto Sans KR","Malgun Gothic",sans-serif;
      color:var(--text);
      background: radial-gradient(1200px 500px at 10% 0%, rgba(37,99,235,.10), transparent 60%),
                  radial-gradient(1000px 500px at 90% 0%, rgba(100,116,139,.12), transparent 60%),
                  var(--bg);
      overflow-x:hidden;
    }
    a{color:inherit; text-decoration:none}
    button,input,select,textarea{font:inherit}
    .wrap{width:min(var(--max), 100%); margin:0 auto; padding:0 16px;}
    /* Header */
    .header{
      position:sticky; top:0; z-index:20;
      backdrop-filter:blur(10px);
      background:rgba(245,248,252,.78);
      border-bottom:1px solid rgba(226,232,240,.75);
    }
    .header-inner{padding:16px 0; display:grid; gap:12px;}
    .title-row{display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap}
    .brand{display:flex; align-items:center; gap:10px; min-width:260px}
    .badge{
      width:36px;height:36px;border-radius:12px;
      background:linear-gradient(135deg,var(--blue),#60A5FA);
      box-shadow:0 10px 20px rgba(37,99,235,.18);
      display:grid; place-items:center; color:#fff; font-weight:900;
    }
    h1{margin:0; font-size:18px; letter-spacing:-.2px}
    .subtitle{margin:2px 0 0; color:var(--muted); font-size:12px}

    .search{flex:1; min-width:260px; display:flex; gap:10px; align-items:center}
    .searchbox{position:relative; flex:1}
    .searchbox input{
      width:100%; padding:12px 14px 12px 40px; border-radius:999px;
      border:1px solid var(--line); background:rgba(255,255,255,.86);
      outline:none; box-shadow:0 4px 18px rgba(15,23,42,.04);
      transition:.15s ease;
    }
    .searchbox input:focus{border-color:rgba(37,99,235,.55); box-shadow:var(--focus); background:#fff}
    .searchbox .icon{position:absolute; left:14px; top:50%; transform:translateY(-50%); width:16px; height:16px; opacity:.65}

    .btn{
      border:1px solid var(--line); background:rgba(255,255,255,.9);
      padding:10px 12px; border-radius:999px; cursor:pointer;
      transition:.15s ease; color:var(--text); font-weight:800; white-space:nowrap;
    }
    .btn:hover{background:#fff; border-color:rgba(37,99,235,.35)}
    .btn:focus{outline:none; box-shadow:var(--focus)}
    .btn.secondary{color:var(--muted); font-weight:800;}
    .btn.primary{
      border-color:rgba(37,99,235,.35);
      background:rgba(37,99,235,.08);
      color:var(--blue2);
    }

    /* Filters */
    .filters{display:grid; gap:10px;}
    .filter-row{display:flex; flex-wrap:wrap; gap:8px; align-items:center; justify-content:space-between}
    .filter-group{display:flex; flex-wrap:wrap; gap:8px; align-items:center}
    .chip{
      border:1px solid var(--line); background:rgba(255,255,255,.78);
      padding:9px 12px; border-radius:999px; cursor:pointer;
      transition:.15s ease; color:var(--text); font-weight:900; font-size:13px;
    }
    .chip:hover{background:#fff; border-color:rgba(37,99,235,.35)}
    .chip[aria-pressed="true"]{background:var(--chip); border-color:rgba(37,99,235,.45); color:var(--blue2)}
    .chip:focus{outline:none; box-shadow:var(--focus)}
    .meta{display:flex; align-items:center; gap:10px; color:var(--muted); font-size:12px; white-space:nowrap}
    .dot{width:4px;height:4px;border-radius:999px;background:rgba(100,116,139,.55);display:inline-block}

    /* Main */
    main{padding:18px 0 40px;}
    .grid{display:grid; grid-template-columns:repeat(12,1fr); gap:14px}
    .card{
      grid-column:span 6;
      background:rgba(255,255,255,.88);
      border:1px solid rgba(226,232,240,.92);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
      transition:.12s ease;
      display:flex; flex-direction:column;
    }
    .card:hover{transform:translateY(-2px); border-color:rgba(37,99,235,.25); background:#fff; box-shadow:0 18px 45px rgba(15,23,42,.10)}
    .card-top{display:flex; align-items:flex-start; gap:12px; padding:16px 16px 10px}
    .logo{
      width:44px;height:44px;border-radius:12px; object-fit:contain;
      background:#fff; border:1px solid #E2E8F0; padding:6px; flex:none;
    }
    .logo-fallback{
      width:44px;height:44px;border-radius:12px;
      background:linear-gradient(135deg,#0F172A,#64748B);
      border:1px solid rgba(226,232,240,.9);
      display:grid; place-items:center; color:#fff; font-weight:900;
    }
    .tag{font-size:12px; color:var(--muted); margin:0}
    .card-title{margin:0; font-size:15px; letter-spacing:-.2px; line-height:1.35}
    .card-body{padding:0 16px 12px; display:grid; gap:8px; flex:1}
    .benefit{margin:0; color:var(--muted); font-size:13px; line-height:1.5}
    .info-row{display:flex; flex-wrap:wrap; gap:8px; align-items:center; margin-top:4px}
    .pill{
      display:inline-flex; align-items:center; gap:6px;
      padding:7px 10px; border-radius:999px;
      background:rgba(15,23,42,.04);
      border:1px solid rgba(226,232,240,.9);
      color:#334155; font-size:12px; font-weight:900;
    }
    .badge-cat{
      display:inline-flex; align-items:center; gap:6px;
      padding:7px 10px; border-radius:999px;
      border:1px solid rgba(226,232,240,.9);
      font-size:12px; font-weight:900;
    }
    .cat-ISSUE_CASHBACK{background:rgba(22,163,74,.10); color:#166534; border-color:rgba(22,163,74,.22)}
    .cat-SPEND_MISSION{background:rgba(245,158,11,.12); color:#92400E; border-color:rgba(245,158,11,.28)}
    .cat-OTHER{background:rgba(37,99,235,.08); color:var(--blue2); border-color:rgba(37,99,235,.22)}

    .card-actions{
      padding:12px 16px 16px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      border-top:1px solid rgba(226,232,240,.75);
      background:linear-gradient(180deg, rgba(255,255,255,.0), rgba(255,255,255,.7));
      flex-wrap:wrap;
    }
    .btn-sq{
      display:inline-flex; align-items:center; gap:8px;
      border:1px solid rgba(37,99,235,.35);
      background:rgba(37,99,235,.08);
      color:var(--blue2);
      padding:10px 12px; border-radius:12px; cursor:pointer;
      transition:.15s ease; font-weight:900; font-size:13px; white-space:nowrap;
    }
    .btn-sq:hover{background:rgba(37,99,235,.12); border-color:rgba(37,99,235,.5)}
    .btn-sq:focus{outline:none; box-shadow:var(--focus)}
    .btn-sq.ghost{
      border-color:rgba(226,232,240,.95);
      background:#fff; color:#334155;
    }
    .btn-sq.ghost:hover{border-color:rgba(37,99,235,.35)}

    .empty{
      grid-column:1/-1;
      border:1px dashed rgba(148,163,184,.7);
      border-radius:var(--radius);
      background:rgba(255,255,255,.6);
      padding:22px 18px; color:var(--muted); display:none;
    }
    .empty strong{color:var(--text)}

    /* Modal */
    .backdrop{
      position:fixed; inset:0; background:rgba(2,6,23,.55);
      display:none; align-items:center; justify-content:center; padding:18px; z-index:50;
    }
    .modal{
      width:min(820px,100%);
      border-radius:18px; background:#fff;
      border:1px solid rgba(226,232,240,.9);
      box-shadow:0 30px 90px rgba(0,0,0,.25);
      overflow:hidden;
    }
    .modal-header{
      padding:14px 16px; border-bottom:1px solid rgba(226,232,240,.9);
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
      background:linear-gradient(180deg, rgba(37,99,235,.06), rgba(255,255,255,1));
    }
    .modal-title{margin:0; font-size:16px; line-height:1.3; letter-spacing:-.2px}
    .modal-sub{margin:4px 0 0; color:var(--muted); font-size:12px}
    .close{
      border:1px solid rgba(226,232,240,.9); background:rgba(255,255,255,.95);
      width:36px;height:36px;border-radius:12px; cursor:pointer; display:grid; place-items:center;
    }
    .close:focus{outline:none; box-shadow:var(--focus)}
    .modal-body{padding:16px; display:grid; gap:12px}
    .modal-body p{margin:0; line-height:1.6; color:#334155; font-size:14px}
    .modal-footer{
      padding:14px 16px; border-top:1px solid rgba(226,232,240,.9);
      display:flex; align-items:center; justify-content:space-between; gap:10px; background:rgba(248,250,252,.75);
      flex-wrap:wrap;
    }
    .links{display:flex; gap:10px; flex-wrap:wrap}
    .links a{font-size:12px; color:var(--blue2); font-weight:900}
    .links a:hover{text-decoration:underline}
    .note{font-size:12px; color:var(--muted)}

    /* Admin */
    .admin-grid{display:grid; grid-template-columns: 1.1fr .9fr; gap:14px}
    .panel{
      border:1px solid rgba(226,232,240,.95);
      background:rgba(248,250,252,.70);
      border-radius:16px; padding:12px;
    }
    .panel h3{margin:0 0 10px; font-size:14px}
    .table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      overflow:hidden;
      border:1px solid rgba(226,232,240,.95);
      border-radius:14px;
      background:#fff;
    }
    .table th,.table td{
      padding:10px;
      font-size:12px;
      border-bottom:1px solid rgba(226,232,240,.8);
      vertical-align:top;
    }
    .table th{
      text-align:left;
      color:#334155;
      background:rgba(37,99,235,.05);
      font-weight:900;
    }
    .table tr:last-child td{border-bottom:none}
    .muted{color:var(--muted)}
    .row-actions{display:flex; gap:8px; flex-wrap:wrap}
    .mini{
      border:1px solid rgba(226,232,240,.95);
      background:#fff;
      padding:7px 9px;
      border-radius:10px;
      cursor:pointer;
      font-size:12px;
      font-weight:900;
    }
    .mini:hover{border-color:rgba(37,99,235,.35)}
    .mini.danger{border-color:rgba(220,38,38,.35); color:#991B1B; background:rgba(220,38,38,.06)}
    .mini.danger:hover{border-color:rgba(220,38,38,.55)}
    .form{
      display:grid; gap:10px;
    }
    .field{
      display:grid; gap:6px;
    }
    .field label{font-size:12px; color:#334155; font-weight:900}
    .field input,.field select,.field textarea{
      width:100%;
      border:1px solid rgba(226,232,240,.95);
      background:#fff;
      border-radius:12px;
      padding:10px 10px;
      outline:none;
      font-size:13px;
    }
    .field textarea{min-height:88px; resize:vertical}
    .field input:focus,.field select:focus,.field textarea:focus{box-shadow:var(--focus); border-color:rgba(37,99,235,.45)}
    .form-actions{display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end}
    .hint{font-size:12px; color:var(--muted); line-height:1.5}

    @media (max-width:980px){ .card{grid-column:span 12} .admin-grid{grid-template-columns:1fr} }
    @media (max-width:520px){
      h1{font-size:16px}
      .search{min-width:100%}
      .card-top{padding:14px 14px 10px}
      .card-body{padding:0 14px 10px}
      .card-actions{padding:12px 14px 14px}
    }
  </style>
</head>
<body>

<header class="header">
  <div class="wrap">
    <div class="header-inner">
      <div class="title-row">
        <div class="brand">
          <div class="badge">C</div>
          <div>
            <h1>오늘의 카드사 혜택 모음</h1>
            <p class="subtitle">카드사/금융사 이벤트를 필터링하고, 관리자 페이지에서 직접 운영하세요</p>
          </div>
        </div>

        <div class="search" role="search">
          <div class="searchbox">
            <svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15Z" stroke="currentColor" stroke-width="2" />
              <path d="M16.5 16.5 21 21" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
            <input id="searchInput" type="search" placeholder="이벤트 제목/혜택 내용 검색" autocomplete="off" />
          </div>
          <button id="themeToggleBtn" class="btn" type="button">다크 모드</button>
          <button id="resetBtn" class="btn secondary" type="button">초기화</button>
          <button id="adminBtn" class="btn primary" type="button">관리자</button>
        </div>
      </div>

      <div class="filters">
        <!-- Issuer filter -->
        <div class="filter-row">
          <div class="filter-group" aria-label="카드사/금융사 필터">
            <button class="chip" type="button" data-filter-type="issuer" data-filter="ALL" aria-pressed="true">전체</button>
            <button class="chip" type="button" data-filter-type="issuer" data-filter="SHINHAN">신한</button>
            <button class="chip" type="button" data-filter-type="issuer" data-filter="HYUNDAI">현대</button>
            <button class="chip" type="button" data-filter-type="issuer" data-filter="SAMSUNG">삼성</button>
            <button class="chip" type="button" data-filter-type="issuer" data-filter="KB">국민</button>
            <button class="chip" type="button" data-filter-type="issuer" data-filter="WOORI">우리</button>
            <button class="chip" type="button" data-filter-type="issuer" data-filter="HANA">하나</button>
            <button class="chip" type="button" data-filter-type="issuer" data-filter="LOTTE">롯데</button>
            <button class="chip" type="button" data-filter-type="issuer" data-filter="NH">농협</button>
            <button class="chip" type="button" data-filter-type="issuer" data-filter="BC">BC/페이북</button>
            <button class="chip" type="button" data-filter-type="issuer" data-filter="NAVERPAY">네이버페이</button>
            <button class="chip" type="button" data-filter-type="issuer" data-filter="KAKAOBANK">카카오뱅크</button>
            <button class="chip" type="button" data-filter-type="issuer" data-filter="TOSSBANK">토스뱅크</button>
          </div>
          <div class="meta" aria-live="polite">
            <span>표시 중: <strong id="countText">0</strong>건</span>
            <span class="dot" aria-hidden="true"></span>
            <span id="activeFilterText">카드사: 전체 · 카테고리: 전체</span>
          </div>
        </div>

        <!-- Category filter -->
        <div class="filter-row">
          <div class="filter-group" aria-label="카테고리 필터">
            <button class="chip" type="button" data-filter-type="category" data-filter="ALL" aria-pressed="true">카테고리 전체</button>
            <button class="chip" type="button" data-filter-type="category" data-filter="ISSUE_CASHBACK" aria-pressed="false">발급/캐시백</button>
            <button class="chip" type="button" data-filter-type="category" data-filter="SPEND_MISSION" aria-pressed="false">결제실적형</button>
            <button class="chip" type="button" data-filter-type="category" data-filter="OTHER" aria-pressed="false">기타</button>
          </div>
          <div class="meta">
            <span class="muted">※ 관리자에서 이벤트에 카테고리를 지정할 수 있어요</span>
          </div>
        </div>
      </div>

    </div>
  </div>
</header>

<div class="wrap">
  <main>
    <section class="grid" id="cardsGrid" aria-label="이벤트 리스트">
      <div class="empty" id="emptyState">
        <strong>조건에 맞는 이벤트가 없어요.</strong><br/>
        필터를 바꾸거나 검색어를 수정해 보세요.
      </div>
    </section>
  </main>
</div>

<!-- Detail/Admin Modal -->
<div class="backdrop" id="backdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="modal-header">
      <div>
        <h2 class="modal-title" id="modalTitle">상세 보기</h2>
        <p class="modal-sub" id="modalSub">-</p>
      </div>
      <button class="close" id="closeBtn" type="button" aria-label="닫기">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M6 6 18 18M18 6 6 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </button>
    </div>

    <div class="modal-body" id="modalBody"></div>

    <div class="modal-footer">
      <div class="note" id="modalNote">공식 페이지 기준으로 최신 내용 확인을 권장합니다.</div>
      <div class="links" id="modalLinks"></div>
    </div>
  </div>
</div>

<script>
  // =========================
  // 0) 설정
  // =========================
  const USE_API = false;              // ✅ 실제 서비스/API 붙이면 true 로
  const API_BASE = "";                // 예: "https://api.example.com"
  const API_ENDPOINT = "/api/events"; // 예: GET /api/events?issuer=...&category=...&q=...

  // 로컬 관리자 데이터 저장 키
  const LS_KEY = "card_benefits_admin_events_v1";

  // =========================
  // 1) "최신 공식" 이벤트/혜택 페이지 링크
  // =========================
  const OFFICIAL_PAGES = {
    SHINHAN:  { name:"신한카드",     eventsUrl:"https://www.shinhancard.com/conts/person/event/event/on_going_event.jsp" },
    HYUNDAI:  { name:"현대카드",     eventsUrl:"https://card.hyundaicard.com/EVENTS" },
    SAMSUNG:  { name:"삼성카드",     eventsUrl:"https://www.samsungcard.com/personal/event/ing/UHPPBE1401M0.jsp" },
    KB:       { name:"KB국민카드",   eventsUrl:"https://m.kbcard.com/CXHIABNC0076.cms" },
    WOORI:    { name:"우리카드",     eventsUrl:"https://pc.wooricard.com/dcpc/yh1/bnf/bnf02/prgevnt/H1BNF202S00.do" },
    HANA:     { name:"하나카드",     eventsUrl:"https://m.hanacard.co.kr/MKEVT1000M.web" },
    LOTTE:    { name:"롯데카드",     eventsUrl:"https://jiwon3.lottecard.co.kr/app/LPBNFDA_V100.lc" },
    NH:       { name:"NH농협카드",   eventsUrl:"https://nhpay.nonghyup.com/bn/BN600000F" },
    BC:       { name:"BC카드/페이북", eventsUrl:"https://web.paybooc.co.kr/web/evnt/main" },
    NAVERPAY: { name:"네이버페이 카드 이벤트", eventsUrl:"https://card.pay.naver.com/home/promotion/event" },
    KAKAOBANK:{ name:"카카오뱅크 이벤트", eventsUrl:"https://m.kakaobank.com/Events" },
    TOSSBANK: { name:"토스뱅크 카드 혜택", eventsUrl:"https://www.tossbank.com/card/benefits" }
  };

  // =========================
  // 2) 로고: 각 도메인 favicon(가볍고 잘 뜸). 로고 차단시 자동 fallback
  // =========================
  const LOGO_URL = {
    SHINHAN:  "https://www.shinhancard.com/favicon.ico",
    HYUNDAI:  "https://card.hyundaicard.com/favicon.ico",
    SAMSUNG:  "https://www.samsungcard.com/favicon.ico",
    KB:       "https://m.kbcard.com/favicon.ico",
    WOORI:    "https://pc.wooricard.com/favicon.ico",
    HANA:     "https://m.hanacard.co.kr/favicon.ico",
    LOTTE:    "https://www.lottecard.co.kr/favicon.ico",
    NH:       "https://nhpay.nonghyup.com/favicon.ico",
    BC:       "https://web.paybooc.co.kr/favicon.ico",
    NAVERPAY: "https://pay.naver.com/favicon.ico",
    KAKAOBANK:"https://m.kakaobank.com/favicon.ico",
    TOSSBANK: "https://www.tossbank.com/favicon.ico"
  };

  // =========================
  // 3) 카테고리(요청 반영)
  // =========================
  const CATEGORIES = {
    ISSUE_CASHBACK: { label: "발급/캐시백", css: "cat-ISSUE_CASHBACK" },
    SPEND_MISSION:  { label: "결제실적형",  css: "cat-SPEND_MISSION" },
    OTHER:          { label: "기타",        css: "cat-OTHER" }
  };

  // =========================
  // 4) 샘플(개발/데모)
  // =========================
  const SAMPLE_EVENTS = [
    {
      id:"sample-issue-1",
      issuer:"NAVERPAY",
      issuerName:"네이버페이",
      category:"ISSUE_CASHBACK",
      title:"(샘플) 카드 신규 발급 캐시백 이벤트",
      benefit:"대상 카드 신규 발급/조건 충족 시 캐시백 제공",
      period:"월별 상이",
      eventUrl:"https://card.pay.naver.com/home/promotion/event",
      details:["대상자/카드별 혜택은 상세 페이지 확인"]
    },
    {
      id:"sample-spend-1",
      issuer:"KB",
      issuerName:"KB국민카드",
      category:"SPEND_MISSION",
      title:"(샘플) 결제 실적 미션형 이벤트",
      benefit:"기간 내 누적 결제 조건 달성 시 혜택 제공",
      period:"이벤트별 상이",
      eventUrl:"https://m.kbcard.com/CXHIABNC0076.cms",
      details:["실적 조건/제외 업종 등 유의사항 확인"]
    },
    {
      id:"sample-other-1",
      issuer:"KAKAOBANK",
      issuerName:"카카오뱅크",
      category:"OTHER",
      title:"(샘플) 카카오뱅크 이벤트 모아보기",
      benefit:"진행중 이벤트 목록에서 최신 혜택 확인",
      period:"이벤트별 상이",
      eventUrl:"https://m.kakaobank.com/Events",
      details:["이벤트별 기간/대상 상이"]
    }
  ];

  // =========================
  // State
  // =========================
  let issuerFilter = "ALL";
  let categoryFilter = "ALL";
  let searchQuery = "";

  // 서버/샘플에서 가져온 이벤트
  let baseEvents = [];
  // 관리자가 저장한 이벤트(로컬)
  let adminEvents = [];

  // =========================
  // DOM
  // =========================
  const gridEl = document.getElementById("cardsGrid");
  const emptyEl = document.getElementById("emptyState");
  const countTextEl = document.getElementById("countText");
  const activeFilterTextEl = document.getElementById("activeFilterText");
  const searchInput = document.getElementById("searchInput");
  const resetBtn = document.getElementById("resetBtn");
  const adminBtn = document.getElementById("adminBtn");

  const backdrop = document.getElementById("backdrop");
  const closeBtn = document.getElementById("closeBtn");
  const modalTitle = document.getElementById("modalTitle");
  const modalSub = document.getElementById("modalSub");
  const modalBody = document.getElementById("modalBody");
  const modalLinks = document.getElementById("modalLinks");
  const modalNote = document.getElementById("modalNote");

  // =========================
  // Utils
  // =========================
  function escapeHtml(str){
    return String(str ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function issuerLabel(code){
    if(code === "ALL") return "전체";
    return OFFICIAL_PAGES[code]?.name || code;
  }

  function categoryLabel(code){
    if(code === "ALL") return "전체";
    return CATEGORIES[code]?.label || "기타";
  }

  function effectiveLogoUrl(ev){
    return ev.logoUrl || LOGO_URL[ev.issuer] || "";
  }

  function getAllEventsMerged(){
    // 관리자 이벤트가 baseEvents의 동일 id를 덮어쓰도록 병합
    const map = new Map();
    for(const e of baseEvents){ map.set(String(e.id), e); }
    for(const e of adminEvents){ map.set(String(e.id), e); }
    return Array.from(map.values());
  }

  function matchesFilters(ev){
    if(issuerFilter !== "ALL" && ev.issuer !== issuerFilter) return false;
    if(categoryFilter !== "ALL" && (ev.category || "OTHER") !== categoryFilter) return false;

    const q = searchQuery.trim().toLowerCase();
    if(q){
      const hay = `${ev.title} ${ev.benefit} ${ev.issuerName} ${ev.period}`.toLowerCase();
      if(!hay.includes(q)) return false;
    }
    return true;
  }

  // =========================
  // Render cards
  // =========================
  function render(){
    const list = getAllEventsMerged().filter(matchesFilters);

    // clear cards
    Array.from(gridEl.querySelectorAll(".card")).forEach(n => n.remove());

    emptyEl.style.display = list.length ? "none" : "block";
    countTextEl.textContent = String(list.length);
    activeFilterTextEl.textContent = `카드사: ${issuerLabel(issuerFilter)} · 카테고리: ${categoryLabel(categoryFilter)}`;

    for(const ev of list){
      const cat = ev.category || "OTHER";
      const catMeta = CATEGORIES[cat] || CATEGORIES.OTHER;
      const logoUrl = effectiveLogoUrl(ev);
      const fallbackText = (ev.issuerName || ev.issuer || "?").slice(0,2);

      const card = document.createElement("article");
      card.className = "card";
      card.innerHTML = `
        <div class="card-top">
          <img class="logo" src="${escapeHtml(logoUrl)}" alt="${escapeHtml(ev.issuerName)} 로고"
               onerror="this.outerHTML='<div class=&quot;logo-fallback&quot;>${escapeHtml(fallbackText)}</div>'" />
          <div style="min-width:0">
            <p class="tag">${escapeHtml(ev.issuerName || issuerLabel(ev.issuer))}</p>
            <h3 class="card-title">${escapeHtml(ev.title || "")}</h3>
          </div>
        </div>

        <div class="card-body">
          <p class="benefit">${escapeHtml(ev.benefit || "")}</p>
          <div class="info-row">
            <span class="badge-cat ${catMeta.css}">${escapeHtml(catMeta.label)}</span>
            <span class="pill">기간: ${escapeHtml(ev.period || "이벤트별 상이")}</span>
          </div>
        </div>

        <div class="card-actions">
          <button class="btn-sq" type="button" data-action="detail" data-id="${escapeHtml(ev.id)}">
            상세 보기
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M9 18 15 12 9 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>
          <button class="btn-sq ghost" type="button" data-action="official" data-issuer="${escapeHtml(ev.issuer)}">
            공식 이벤트
          </button>
        </div>
      `;
      gridEl.insertBefore(card, emptyEl);
    }
  }

  // =========================
  // Detail modal
  // =========================
  function openDetail(ev){
    const issuerName = ev.issuerName || issuerLabel(ev.issuer);
    const cat = ev.category || "OTHER";
    const catMeta = CATEGORIES[cat] || CATEGORIES.OTHER;

    modalTitle.textContent = ev.title || "상세 보기";
    modalSub.textContent = `${issuerName} · ${catMeta.label} · 기간 ${ev.period || "이벤트별 상이"}`;

    const details = Array.isArray(ev.details) ? ev.details : (ev.detailsText ? String(ev.detailsText).split("\n") : []);
    modalBody.innerHTML = `
      <p><strong>혜택 요약</strong><br/>${escapeHtml(ev.benefit || "-")}</p>
      ${details.length ? `
        <p><strong>상세 안내</strong></p>
        <ul style="margin:0; padding-left:18px; color:#334155; line-height:1.7;">
          ${details.map(d => `<li>${escapeHtml(d)}</li>`).join("")}
        </ul>
      ` : ""}
      <p style="font-size:12px; color:#64748B;">
        실제 혜택/대상/한도/유의사항은 공식 페이지 기준으로 확인하세요.
      </p>
    `;

    modalLinks.innerHTML = "";
    const official = OFFICIAL_PAGES[ev.issuer]?.eventsUrl;
    if(ev.eventUrl){
      const a = document.createElement("a");
      a.href = ev.eventUrl; a.target="_blank"; a.rel="noopener noreferrer";
      a.textContent = "이벤트 상세 페이지";
      modalLinks.appendChild(a);
    }
    if(official){
      const a2 = document.createElement("a");
      a2.href = official; a2.target="_blank"; a2.rel="noopener noreferrer";
      a2.textContent = "공식 이벤트 목록";
      modalLinks.appendChild(a2);
    }
    modalNote.textContent = "공식 페이지 기준으로 최신 내용 확인을 권장합니다.";

    backdrop.style.display = "flex";
    backdrop.setAttribute("aria-hidden","false");
    document.body.style.overflow = "hidden";
    closeBtn.focus();
  }

  function openAdmin(){
    // 관리자 화면을 모달에 렌더링
    modalTitle.textContent = "관리자";
    modalSub.textContent = "이벤트 등록 · 수정 · 삭제 (이 PC/브라우저에 로컬 저장)";
    modalNote.textContent = "저장된 데이터는 LocalStorage에 보관됩니다. (공유/배포용이면 서버 DB로 이전 권장)";

    const allMerged = getAllEventsMerged();
    const adminOnly = adminEvents.slice().sort((a,b) => String(a.updatedAt||"").localeCompare(String(b.updatedAt||""))).reverse();

    modalBody.innerHTML = `
      <div class="admin-grid">
        <div class="panel">
          <h3>등록된 이벤트 (로컬 관리자 데이터)</h3>
          <div class="hint">• 여기서 만든 이벤트는 “공식/샘플” 위에 <b>덮어쓰기</b> 됩니다(같은 id인 경우).<br/>• id는 유니크하게(예: sh-202602-001) 추천</div>
          <div style="height:10px"></div>

          <table class="table">
            <thead>
              <tr>
                <th style="width:18%">id</th>
                <th>제목</th>
                <th style="width:14%">카드사</th>
                <th style="width:16%">카테고리</th>
                <th style="width:18%">작업</th>
              </tr>
            </thead>
            <tbody>
              ${
                adminOnly.length ? adminOnly.map(e => `
                  <tr>
                    <td><span class="muted">${escapeHtml(e.id)}</span></td>
                    <td>
                      <div style="font-weight:900">${escapeHtml(e.title || "")}</div>
                      <div class="muted" style="margin-top:4px">${escapeHtml(e.period || "")}</div>
                    </td>
                    <td>${escapeHtml(issuerLabel(e.issuer))}</td>
                    <td>${escapeHtml(categoryLabel(e.category || "OTHER"))}</td>
                    <td>
                      <div class="row-actions">
                        <button class="mini" data-action="admin-edit" data-id="${escapeHtml(e.id)}">수정</button>
                        <button class="mini danger" data-action="admin-delete" data-id="${escapeHtml(e.id)}">삭제</button>
                      </div>
                    </td>
                  </tr>
                `).join("") : `
                  <tr><td colspan="5" class="muted">아직 등록된 이벤트가 없어요. 오른쪽 폼에서 추가해보세요.</td></tr>
                `
              }
            </tbody>
          </table>

          <div style="height:12px"></div>
          <div class="row-actions">
            <button class="mini" data-action="admin-export">내 이벤트 내보내기(JSON)</button>
            <button class="mini" data-action="admin-import">가져오기(JSON 붙여넣기)</button>
            <button class="mini danger" data-action="admin-clear">전체 삭제(로컬)</button>
          </div>
        </div>

        <div class="panel">
          <h3 id="formTitle">이벤트 추가</h3>
          <form class="form" id="adminForm">
            <div class="field">
              <label>id (유니크)</label>
              <input name="id" placeholder="예: sh-202602-001" required />
            </div>

            <div class="field">
              <label>카드사/금융사</label>
              <select name="issuer" required>
                ${Object.keys(OFFICIAL_PAGES).map(k => `<option value="${k}">${escapeHtml(OFFICIAL_PAGES[k].name)}</option>`).join("")}
              </select>
            </div>

            <div class="field">
              <label>카테고리</label>
              <select name="category" required>
                <option value="ISSUE_CASHBACK">발급/캐시백</option>
                <option value="SPEND_MISSION">결제실적형</option>
                <option value="OTHER">기타</option>
              </select>
            </div>

            <div class="field">
              <label>이벤트 제목</label>
              <input name="title" placeholder="예: 신규 발급 시 연회비 캐시백" required />
            </div>

            <div class="field">
              <label>혜택 내용(요약)</label>
              <textarea name="benefit" placeholder="예: 조건 충족 시 최대 10만원 캐시백" required></textarea>
            </div>

            <div class="field">
              <label>유효 기간</label>
              <input name="period" placeholder="예: 2026.02.01 ~ 2026.02.29" />
            </div>

            <div class="field">
              <label>이벤트 상세 링크(공식 상세 URL)</label>
              <input name="eventUrl" placeholder="https://..." />
            </div>

            <div class="field">
              <label>상세 안내(줄바꿈으로 항목 구분)</label>
              <textarea name="detailsText" placeholder="대상: ...&#10;조건: ...&#10;유의: ..."></textarea>
            </div>

            <div class="form-actions">
              <button class="btn-sq ghost" type="button" data-action="admin-cancel">취소</button>
              <button class="btn-sq" type="submit">저장</button>
            </div>
          </form>
          <div class="hint" style="margin-top:10px">
            • 저장하면 카드 리스트에 즉시 반영됩니다.<br/>
            • 실제 서비스 운영은 API/DB 연동(서버 저장)으로 확장하는 걸 권장해요.
          </div>
        </div>
      </div>
    `;

    modalLinks.innerHTML = "";
    backdrop.style.display = "flex";
    backdrop.setAttribute("aria-hidden","false");
    document.body.style.overflow = "hidden";
    closeBtn.focus();
  }

  function closeModal(){
    backdrop.style.display = "none";
    backdrop.setAttribute("aria-hidden","true");
    document.body.style.overflow = "";
  }

  // =========================
  // LocalStorage admin CRUD
  // =========================
  function loadAdminEvents(){
    try{
      const raw = localStorage.getItem(LS_KEY);
      const arr = raw ? JSON.parse(raw) : [];
      adminEvents = Array.isArray(arr) ? arr : [];
    }catch{
      adminEvents = [];
    }
  }

  function saveAdminEvents(){
    localStorage.setItem(LS_KEY, JSON.stringify(adminEvents));
  }

  function upsertAdminEvent(payload){
    const id = String(payload.id).trim();
    const idx = adminEvents.findIndex(e => String(e.id) === id);
    if(idx >= 0) adminEvents[idx] = payload;
    else adminEvents.push(payload);
    saveAdminEvents();
  }

  function deleteAdminEvent(id){
    adminEvents = adminEvents.filter(e => String(e.id) !== String(id));
    saveAdminEvents();
  }

  // =========================
  // API load
  // =========================
  async function loadBaseEvents(){
    if(!USE_API){
      baseEvents = SAMPLE_EVENTS;
      return;
    }

    const params = new URLSearchParams();
    if(issuerFilter !== "ALL") params.set("issuer", issuerFilter);
    if(categoryFilter !== "ALL") params.set("category", categoryFilter);
    if(searchQuery.trim()) params.set("q", searchQuery.trim());

    const url = `${API_BASE}${API_ENDPOINT}?${params.toString()}`;
    const res = await fetch(url, { headers: { "Accept":"application/json" } });
    if(!res.ok) throw new Error(`API error ${res.status}`);
    const data = await res.json();
    baseEvents = Array.isArray(data.items) ? data.items : [];
  }

  async function refresh(){
    loadAdminEvents();
    try{
      await loadBaseEvents();
    }catch(err){
      console.warn("API 실패 → 샘플 사용:", err);
      baseEvents = SAMPLE_EVENTS;
    }
    render();
  }

  // =========================
  // Filter buttons
  // =========================
  function setPressed(filterType, value){
    document.querySelectorAll(`.chip[data-filter-type="${filterType}"]`).forEach(btn => {
      btn.setAttribute("aria-pressed", String(btn.dataset.filter === value));
    });
  }

  document.addEventListener("click", async (e) => {
    const chip = e.target.closest(".chip");
    if(chip){
      const type = chip.dataset.filterType;
      const val = chip.dataset.filter;

      if(type === "issuer"){
        issuerFilter = val;
        setPressed("issuer", val);
      }else if(type === "category"){
        categoryFilter = val;
        setPressed("category", val);
      }

      await refresh();
      return;
    }

    const detailBtn = e.target.closest('[data-action="detail"]');
    if(detailBtn){
      const id = detailBtn.dataset.id;
      const ev = getAllEventsMerged().find(x => String(x.id) === String(id));
      if(ev) openDetail(ev);
      return;
    }

    const officialBtn = e.target.closest('[data-action="official"]');
    if(officialBtn){
      const issuer = officialBtn.dataset.issuer;
      const url = OFFICIAL_PAGES[issuer]?.eventsUrl;
      if(url) window.open(url, "_blank", "noopener,noreferrer");
      return;
    }

    // Admin actions (inside modal)
    const act = e.target.closest("[data-action]");
    if(act){
      const action = act.dataset.action;

      if(action === "admin-edit"){
        const id = act.dataset.id;
        const ev = adminEvents.find(x => String(x.id) === String(id));
        if(!ev) return;

        // fill form
        const form = document.getElementById("adminForm");
        if(!form) return;
        document.getElementById("formTitle").textContent = "이벤트 수정";
        form.elements.id.value = ev.id;
        form.elements.id.disabled = true;
        form.elements.issuer.value = ev.issuer;
        form.elements.category.value = ev.category || "OTHER";
        form.elements.title.value = ev.title || "";
        form.elements.benefit.value = ev.benefit || "";
        form.elements.period.value = ev.period || "";
        form.elements.eventUrl.value = ev.eventUrl || "";
        form.elements.detailsText.value = (Array.isArray(ev.details) ? ev.details.join("\n") : (ev.detailsText || ""));
        form.elements.title.focus();
        return;
      }

      if(action === "admin-delete"){
        const id = act.dataset.id;
        if(confirm(`정말 삭제할까요?\n\nid: ${id}`)){
          deleteAdminEvent(id);
          await refresh();
          openAdmin();
        }
        return;
      }

      if(action === "admin-cancel"){
        openAdmin();
        return;
      }

      if(action === "admin-clear"){
        if(confirm("로컬에 저장된 관리자 이벤트를 전부 삭제할까요?")){
          adminEvents = [];
          saveAdminEvents();
          await refresh();
          openAdmin();
        }
        return;
      }

      if(action === "admin-export"){
        const json = JSON.stringify(adminEvents, null, 2);
        navigator.clipboard?.writeText(json).catch(()=>{});
        alert("내 이벤트(JSON)가 클립보드에 복사되었습니다. (붙여넣기 가능)");
        return;
      }

      if(action === "admin-import"){
        const txt = prompt("가져올 JSON 배열을 붙여넣어 주세요.\n(예: [{...},{...}])");
        if(!txt) return;
        try{
          const arr = JSON.parse(txt);
          if(!Array.isArray(arr)) throw new Error("not array");
          // 기본 유효성 최소 체크
          for(const e2 of arr){
            if(!e2.id || !e2.issuer) throw new Error("missing fields");
          }
          adminEvents = arr;
          saveAdminEvents();
          await refresh();
          openAdmin();
        }catch{
          alert("JSON 형식이 올바르지 않거나 필수 필드(id, issuer)가 없습니다.");
        }
        return;
      }
    }
  });

  // Search + reset + admin open
  searchInput.addEventListener("input", async (e) => {
    searchQuery = e.target.value || "";
    clearTimeout(window.__t);
    window.__t = setTimeout(refresh, 250);
  });

  resetBtn.addEventListener("click", async () => {
    issuerFilter = "ALL";
    categoryFilter = "ALL";
    searchQuery = "";
    searchInput.value = "";
    setPressed("issuer", "ALL");
    setPressed("category", "ALL");
    await refresh();
    searchInput.focus();
  });

  adminBtn.addEventListener("click", () => openAdmin());

  // Modal close
  closeBtn.addEventListener("click", closeModal);
  backdrop.addEventListener("click", (e) => { if(e.target === backdrop) closeModal(); });
  window.addEventListener("keydown", (e) => { if(e.key === "Escape" && backdrop.style.display === "flex") closeModal(); });

  // Admin form submit
  document.addEventListener("submit", async (e) => {
    const form = e.target.closest("#adminForm");
    if(!form) return;
    e.preventDefault();

    const payload = {
      id: String(form.elements.id.value).trim(),
      issuer: form.elements.issuer.value,
      issuerName: OFFICIAL_PAGES[form.elements.issuer.value]?.name || form.elements.issuer.value,
      category: form.elements.category.value,
      title: form.elements.title.value.trim(),
      benefit: form.elements.benefit.value.trim(),
      period: form.elements.period.value.trim(),
      eventUrl: form.elements.eventUrl.value.trim(),
      details: (form.elements.detailsText.value || "").split("\n").map(s => s.trim()).filter(Boolean),
      updatedAt: new Date().toISOString()
    };

    if(!payload.id || !payload.issuer || !payload.title || !payload.benefit){
      alert("필수값(id/카드사/제목/혜택)을 확인해주세요.");
      return;
    }

    upsertAdminEvent(payload);

    // 폼 초기화(수정 후에도 다시 추가 모드)
    form.reset();
    form.elements.id.disabled = false;
    document.getElementById("formTitle").textContent = "이벤트 추가";

    await refresh();
    openAdmin();
  });


  // =========================
  // Theme Toggle
  // =========================
  const themeToggleBtn = document.getElementById("themeToggleBtn");
  const LOCAL_STORAGE_THEME_KEY = "theme";

  function saveTheme(theme) {
    localStorage.setItem(LOCAL_STORAGE_THEME_KEY, theme);
  }

  function getSavedTheme() {
    return localStorage.getItem(LOCAL_STORAGE_THEME_KEY);
  }

  function applyTheme(theme) {
    document.documentElement.setAttribute("data-theme", theme);
    themeToggleBtn.textContent = theme === "dark" ? "라이트 모드" : "다크 모드";
  }

  function toggleTheme() {
    const currentTheme = document.documentElement.getAttribute("data-theme");
    const newTheme = currentTheme === "dark" ? "light" : "dark";
    applyTheme(newTheme);
    saveTheme(newTheme);
  }

  function applySavedTheme() {
    const savedTheme = getSavedTheme();
    if (savedTheme) {
      applyTheme(savedTheme);
    } else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
      // Default to dark mode if system preference is dark
      applyTheme('dark');
      saveTheme('dark');
    } else {
      applyTheme('light');
      saveTheme('light');
    }
  }

  themeToggleBtn.addEventListener("click", toggleTheme);

  // Initial
  (async function init(){
    applySavedTheme(); // Apply saved theme or system preference
    setPressed("issuer", "ALL");
    setPressed("category", "ALL");
    await refresh();
  })();
</script>
</body>
</html>